{% extends 'layout.html'%}
{% block content %}
<h1> Class Attendance </h1>
<form method="POST" action="{{ url_for('displayClassAttendanceLogNew') }}" enctype="multipart/form-data">
  {{ logFilters.hidden_tag() }}
  {{ logFilters.identifier(hidden=True, value='logFilters') }}
  <div class="form-group">
    {{ logFilters.teacherName.label(class="form-control-label") }}

    {% if logFilters.teacherName.errors %}
    {{ logFilters.teacherName(class="form-control form-control-sm is-invalid") }}
    <div class="invalid-feedback">
      {% for error in logFilters.teacherName.errors %}
      <span>{{ error }}</span>
      {% endfor %}
    </div>
    {% else %}
    {{ logFilters.teacherName(class="form-control form-control-sm") }}
    {% endif %}
  </div>

  <div class="form-group">
    {{ logFilters.className.label(class="form-control-label") }}

    {% if logFilters.className.errors %}
    {{ logFilters.className(class="form-control form-control-sm is-invalid") }}
    <div class="invalid-feedback">
      {% for error in logFilters.className.errors %}
      <span>{{ error }}</span>
      {% endfor %}
    </div>
    {% else %}
    {{ logFilters.className(class="form-control form-control-sm") }}
    {% endif %}
  </div>
  <div class="form-group">
    {{ logFilters.classDate.label(class="form-control-label") }}

    {% if logFilters.classDate.errors %}
    {{ logFilters.classDate(class="form-control form-control-sm is-invalid") }}
    <div class="invalid-feedback">
      {% for error in logFilters.classDate.errors %}
      <span>{{ error }}</span>
      {% endfor %}
    </div>
    {% else %}
    {{ logFilters.classDate(class="form-control form-control-sm") }}
    {% endif %}
  </div>
  <div class="form-group">
    {{ logFilters.submit.label(class="form-control-label") }}

    {% if logFilters.submit.errors %}
    {{ logFilters.submit(class="form-control form-control-sm is-invalid") }}
    <div class="invalid-feedback">
      {% for error in logFilters.submit.errors %}
      <span>{{ error }}</span>
      {% endfor %}
    </div>
    {% else %}
    {{ logFilters.submit(class="form-control form-control-sm") }}
    {% endif %}
  </div>
</form>



<table class="table table-sm table-hover">
  <thead class="thead-light">
    <tr>
      <th scope="col">Class Name</th>
      <th scope="col">Start Time</th>
      <th scope="col">End Time</th>
      <th scope="col">First Name</th>
      <th scope="col">Last Name</th>
      <th scope="col">Attendance Code</th>
      <th scope="col">Comment</th>
    </tr>
  </thead>
  <tbody>




    {% for studentAttendanceForm, studentFixedFields in zip(classAttendanceForm.classMembers, classAttendanceFixedFields) %}
    <form method="POST" action="{{ url_for('displayClassAttendanceLogNew') }}" enctype="multipart/form-data"
      id="{{'form-' ~ loop.index|string}}">
      {{ classAttendanceForm.hidden_tag() }}
      {{ studentAttendanceForm.hidden_tag() }}
      {{ classAttendanceForm.identifier(hidden=True, value='classAttendanceForm') }}
      {{ studentAttendanceForm.identifier(hidden=True, value='studentAttendanceForm') }}


      <tr>
        <td> {{ studentFixedFields.ClassSchedule.className }}</td>
        <td> {{ studentFixedFields.ClassSchedule.startTime.strftime('%-I:%M') }}</td>
        <td> {{ studentFixedFields.ClassSchedule.endTime.strftime('%-I:%M') }}</td>
        <td> {{ studentFixedFields.ClassSchedule.Student.firstName }}</td>
        <td> {{ studentFixedFields.ClassSchedule.Student.lastName }} </td>
        <td>
          {% for subfield in studentAttendanceForm.attendanceCode %}
          {{ subfield }}
          {{ subfield.label }}
          {% endfor %}
        </td>
        <td>
          {{ studentAttendanceForm.comment(class="form-control form-control-sm", size="30") }}
        </td>
        <td>
          {{ studentAttendanceForm.log_id(type="hidden")}}
        </td>

      </tr>
    </form>
    {% endfor %}




  </tbody>
</table>

<script>
  // Keep track of the scroll position so the page reloads to the same position 
  // after submitting attendance (prevents page from reloading to top of page 
  // when updating attendance records further down the page)
  document.addEventListener("DOMContentLoaded", function (event) {
    var scrollpos = localStorage.getItem('scrollpos');
    if (scrollpos) window.scrollTo(0, scrollpos);
  });

  window.onbeforeunload = function (e) {
    localStorage.setItem('scrollpos', window.scrollY);
  };

  // Set event listerners for updates to radio buttons
  var radioButtons = document.querySelectorAll("input[type=radio]");
  for (i = 0; i < radioButtons.length; i++) {
    radioButtons[i].addEventListener("click", function () { submitUpdate(event); });
  }
  // Set event listerners for updates to comment fields
  var commentFields = document.querySelectorAll("input[type=text]");
  for (i = 0; i < commentFields.length; i++) {
    commentFields[i].addEventListener("blur", function () { submitUpdate(event); });
  }

  // Submit update to attendance on changes to attendanceCode or comment
  function submitUpdate(event) {
    event_id = event.target.id;
    event_split_id = event_id.split('-');
    form_id_number = parseInt(event_split_id[1]) + 1;
    form_id = 'form-' + form_id_number.toString();
    var form = document.getElementById(form_id);
    form.submit();
  }

</script>

{% endblock content %}